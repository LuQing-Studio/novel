# Novel - AI 小说创作助手 开发进度跟踪

**PRD 文档**: [docs/prd/2026-01-22-novel.md](../prd/2026-01-22-novel.md)
**开始日期**: 2026-01-22
**当前状态**: 🟢 Phase 5 完成 - 记忆系统 CRUD API 已实现
**最后更新**: 2026-01-22 (Phase 5 完成)

---

## 📊 总体进度

- **MVP 进度**: 5/6 功能已完成 (83%)
- **验收标准**: 1/7 项已通过 (14%)
- **当前里程碑**: Milestone 1 - MVP (Week 2 - 记忆系统 CRUD API 完成)

---

## ✅ 已完成功能

### Phase 1: 基础架构搭建 - 2026-01-22

- **PRD 章节**: 6. 开发里程碑 - Milestone 1 - Week 1
- **完成内容**:
  - [x] Next.js 15 项目初始化
  - [x] TypeScript + Tailwind CSS 配置
  - [x] 数据类型定义(Novel, Chapter, Character, Foreshadowing, WorldSetting)
  - [x] Mock 数据创建(3章完整小说示例)
  - [x] 首页 UI 实现(小说列表展示)
  - [x] 主题切换功能(暗色/亮色)
  - [x] 移动端响应式适配
  - [x] Literary Workshop 美学设计
  - [x] GitHub 仓库创建(LuQing-Studio/novel)
  - [x] 本地开发环境配置(局域网访问)
- **关键决策**:
  - 使用 Tailwind CSS v4 的新 @theme 语法
  - 采用 Literary Workshop 美学风格(暖色纸质背景 + 琥珀色强调)
  - 使用 serif 字体增强文学氛围
  - 本地开发使用局域网访问,方便移动端测试
- **Git 提交**:
  - `bfa00e7`: 修复 mock.ts 解析错误
  - `1f20e23`: 优化 UI 设计,实现主题切换和移动端适配
- **备注**: 基础架构已完成,UI 设计获得用户认可

### PRD 文档创建 - 2026-01-22

- **PRD 章节**: 全部
- **完成内容**:
  - [x] 第一性原理分析
  - [x] 核心问题定义
  - [x] 功能需求列表
  - [x] 验收标准
  - [x] 技术方案
  - [x] 记忆系统设计
  - [x] 开发里程碑
- **关键决策**:
  - 使用 pgvector 而非 GraphRAG
  - 使用 Claude API 而非 OpenAI
  - 分章节生成而非一次性生成
- **备注**: 通过第一性原理分析,明确了核心问题是"长期一致性",而非"文本生成"

### Phase 2: 小说详情和章节阅读页面 - 2026-01-22

- **PRD 章节**: 3.1 MVP - 基础功能
- **完成内容**:
  - [x] 创建小说详情页面(/novels/[id])
  - [x] 显示小说基本信息和章节列表
  - [x] 创建章节阅读页面(/novels/[id]/chapters/[chapterId])
  - [x] 实现章节导航(上一章/下一章)
  - [x] 移动端阅读体验优化
  - [x] 主题切换功能修复
- **关键决策**:
  - Next.js 15 params 改为 Promise,需要 await 解包
  - Tailwind CSS v4 使用 @variant dark (.dark &) 实现类名控制的暗色模式
- **Git 提交**:
  - `e8f3c42`: 创建小说详情和章节阅读页面
  - `1a2beba`: 修复主题切换功能
- **验证方式**: 使用 Chrome DevTools MCP 进行自动化测试,移动端验收通过
- **备注**: 所有页面功能正常,主题切换工作正常

### Phase 3: 记忆系统 UI - 2026-01-22

- **PRD 章节**: 3.1 MVP - 记忆系统管理
- **完成内容**:
  - [x] 创建记忆系统主页面(/novels/[id]/memory)
  - [x] 创建人物卡列表页面(/novels/[id]/memory/characters)
  - [x] 创建伏笔列表页面(/novels/[id]/memory/foreshadowing)
  - [x] 创建世界观设定页面(/novels/[id]/memory/settings)
  - [x] 在小说详情页添加记忆系统入口按钮
  - [x] 使用 Mock 数据展示功能
- **关键决策**:
  - 使用卡片式布局展示三个类别
  - 人物卡显示状态标签(存活/死亡/未知)
  - 伏笔显示埋下和揭示章节,标记待揭示/已揭示状态
  - 世界观设定按类别(规则/地理/历史/魔法)分类
- **Git 提交**:
  - `f381376`: 实现记忆系统 UI
- **验证方式**: 使用 Chrome DevTools MCP 测试所有页面导航和数据显示
- **备注**: 所有记忆系统页面功能正常,数据展示清晰

---

### Phase 4: 数据库和 API 集成 - 2026-01-22

- **PRD 章节**: 6. 开发里程碑 - Milestone 1 - Week 1
- **完成内容**:
  - [x] 配置 PostgreSQL + pgvector (Docker 容器)
  - [x] 创建数据库 Schema (novels, chapters, characters, foreshadowing, world_settings)
  - [x] 集成多 AI Provider 支持 (OpenAI/Anthropic/Gemini 兼容格式)
  - [x] 配置 DeepSeek API 作为主要 LLM
  - [x] 配置硅基流动 bge-m3 作为 Embedding 模型
  - [x] 安装和启动 LightRAG 服务
  - [x] 创建 LightRAG API 客户端
  - [x] 实现 LightRAG API 端点 (query, documents, health)
  - [x] 创建 LightRAG 测试页面
- **关键决策**:
  - 使用 LightRAG 替代单独的 pgvector + GraphRAG 方案
  - 使用 DeepSeek API (¥1-2/百万tokens) 降低成本
  - 使用硅基流动 bge-m3 (1024维) 作为 Embedding
  - 使用 NetworkXStorage 替代 PGGraphStorage (避免 AGE 扩展依赖)
  - LightRAG 作为独立 Python 服务运行在 9621 端口
- **技术细节**:
  - 修复 OpenAI adapter 的 baseURL 路径拼接问题
  - LightRAG 配置文件需要放在项目根目录
  - 存储配置: PGKVStorage + PGVectorStorage + NetworkXStorage + PGDocStatusStorage
- **Git 提交**:
  - `a9f46e7`: feat: 集成 LightRAG 知识图谱和向量检索
  - `70d8b99`: fix: 修复 DeepSeek API baseURL 路径拼接问题
  - `3bd2b41`: feat: 配置硅基流动 Embedding API
  - `2569cc9`: feat: 成功启动 LightRAG 服务
- **验证方式**: 
  - 使用 Chrome DevTools MCP 测试 DeepSeek API 生成诗歌
  - 测试 LightRAG 健康检查端点
  - 验证配置正确加载 (LLM: deepseek-chat, Embedding: bge-m3)
- **备注**: 
  - 所有服务正常运行
  - DeepSeek API 测试成功
  - LightRAG 服务运行在 http://localhost:9621
  - 测试页面: http://localhost:3000/test-lightrag

### Phase 5: 记忆系统 CRUD API - 2026-01-22

- **PRD 章节**: 6. 开发里程碑 - Milestone 1 - Week 2
- **完成内容**:
  - [x] 实现小说 CRUD API (GET, POST, PUT, DELETE)
  - [x] 实现章节 CRUD API
  - [x] 实现人物 CRUD API
  - [x] 实现伏笔 CRUD API
  - [x] 实现世界观设定 CRUD API
  - [x] 更新所有 UI 页面,从 API 获取数据而非 Mock 数据
  - [x] 修复数据库字段名不匹配问题 (snake_case vs camelCase)
- **关键决策**:
  - API 路由结构: `/api/novels/[id]/characters/[characterId]`
  - 使用 Next.js 15 async params 模式
  - 数据库字段使用 snake_case,前端使用 snake_case 保持一致
- **Git 提交**:
  - 待提交
- **验证方式**:
  - 使用 Chrome DevTools MCP 测试所有页面
  - 测试首页小说列表显示
  - 测试小说详情页面
  - 测试章节阅读页面
  - 测试记忆系统所有页面
- **备注**:
  - 所有 CRUD API 正常工作
  - UI 和 API 成功连接
  - 数据库测试数据已插入

## 🚧 进行中功能

暂无

---

## 📋 待开始功能

### Week 1: 搭建项目基础架构

- **PRD 章节**: 6. 开发里程碑 - Milestone 1
- **优先级**: P0
- **状态**: ✅ 已完成
- **任务列表**:
  - [x] Next.js 项目初始化
  - [ ] PostgreSQL + pgvector 配置
  - [ ] Claude API 集成
  - [x] 基础 UI 框架搭建

### Phase 2: 小说详情和章节阅读页面

- **PRD 章节**: 3.1 MVP - 基础功能
- **优先级**: P0
- **状态**: ✅ 已完成
- **任务列表**:
  - [x] 创建小说详情页面(/novels/[id])
  - [x] 显示小说基本信息和章节列表
  - [x] 创建章节阅读页面(/novels/[id]/chapters/[chapterId])
  - [x] 实现章节导航(上一章/下一章)
  - [x] 移动端阅读体验优化

### Phase 3: 记忆系统 UI

- **PRD 章节**: 3.1 MVP - 记忆系统管理
- **优先级**: P0
- **状态**: ✅ 已完成
- **任务列表**:
  - [x] 创建人物卡管理页面
  - [x] 创建伏笔列表页面
  - [x] 创建世界观设定页面
  - [x] 实现 CRUD 操作(使用 Mock 数据)

### Phase 4: 数据库和 API 集成

- **PRD 章节**: 6. 开发里程碑 - Milestone 1
- **优先级**: P0
- **状态**: ✅ 已完成
- **任务列表**:
  - [x] 配置 PostgreSQL + pgvector
  - [x] 集成 DeepSeek API
  - [x] 实现 LightRAG API 集成
  - [x] 实现向量搜索功能 (LightRAG)

### Week 2: 实现记忆系统

- **PRD 章节**: 3.1 MVP - 记忆系统管理
- **优先级**: P0
- **任务列表**:
  - [ ] 数据模型设计(Character, Foreshadowing, WorldSetting, Chapter)
  - [ ] CRUD API 实现
  - [ ] 向量搜索功能
  - [ ] 记忆系统 UI

### Week 3: 实现核心创作流程

- **PRD 章节**: 3.1 MVP - 交互式设定创建、分章节生成、毒舌编辑审核
- **优先级**: P0
- **任务列表**:
  - [ ] 交互式设定创建
  - [ ] 分章节生成
  - [ ] 毒舌编辑审核

### Week 4: 测试和优化

- **PRD 章节**: 4. 验收标准
- **优先级**: P0
- **任务列表**:
  - [ ] E2E 测试
  - [ ] 一致性测试(生成 10 章)
  - [ ] 部署到 Vercel

---

## 🔄 偏离 PRD 的决策

暂无

---

## 🐛 问题和解决方案

### 问题 1: TypeScript 解析错误 - mock.ts

- **日期**: 2026-01-22
- **问题描述**: 在 mock.ts 中使用三个反引号的代码块导致 TypeScript 解析器将其视为实际代码
- **错误信息**: `Parsing ecmascript source code failed: Expected ',', got 'function'`
- **根本原因**: 字符串字面量中的 markdown 代码块语法与 TypeScript 语法冲突
- **解决方案**: 将 ` ``` ` 替换为 `【代码】` 和 `【/代码】` 标记
- **Git 提交**: `bfa00e7`

### 问题 2: Next.js 15 Params Promise 导致 404

- **日期**: 2026-01-22
- **问题描述**: 点击小说卡片后页面显示 404 错误
- **错误信息**: `Route "/novels/[id]" used params.id. params is a Promise and must be unwrapped with await`
- **根本原因**: Next.js 15 中 params 改为 Promise 类型,需要 await 解包
- **解决方案**:
  1. 将页面组件改为 async 函数
  2. 修改 params 类型为 `Promise<{ id: string }>`
  3. 使用 `const { id } = await params;` 解包
- **影响文件**:
  - `app/novels/[id]/page.tsx`
  - `app/novels/[id]/chapters/[chapterId]/page.tsx`
- **Git 提交**: `e8f3c42`

### 问题 3: 主题切换功能不工作

- **日期**: 2026-01-22
- **问题描述**: 点击主题切换按钮后图标改变但页面主题不变
- **根本原因**: Tailwind CSS v4 需要 `@variant dark (.dark &)` 来启用基于类名的暗色模式
- **解决方案**:
  1. 在 globals.css 中添加 `@variant dark (.dark &);`
  2. 移除 `@media (prefers-color-scheme: dark)` 媒体查询
- **验证方式**: 使用 Chrome DevTools MCP 测试主题切换
- **Git 提交**: `1a2beba`

---

## 📝 验收标准完成情况

### MVP 验收标准

- [x] 用户可以查看和编辑记忆系统中的所有内容
- [ ] 用户可以通过对话创建完整的小说设定(人物、世界观、大纲)
- [ ] 系统能够生成一章 3000 字左右的内容
- [ ] 毒舌编辑能够检测出明显的一致性问题(如死人复活)
- [ ] 生成 10 章后,人物状态和世界观仍然保持一致
- [ ] 页面加载时间 < 3s
- [ ] 支持 Chrome/Safari/Firefox 最新版本

### 完整版验收标准

- [ ] 用户可以修改章节并重新生成
- [ ] 系统能够保存章节的多个版本
- [ ] 用户可以导出完整小说为 TXT 格式

---

## 🧪 测试状态

### E2E 测试

- **总数**: 0 个
- **通过**: 0 个
- **失败**: 0 个
- **覆盖率**: 0%

### 手动测试

- [ ] Chrome 桌面端测试
- [ ] Safari 桌面端测试
- [ ] 移动端测试
- [ ] 边界情况测试

---

## 📈 性能指标

- **页面加载时间**: 未测试 (目标: < 3s)
- **章节生成时间**: 未测试 (目标: < 30s)
- **记忆系统查询时间**: 未测试 (目标: < 1s)

---

## 🎯 下一步计划

1. [x] 初始化 Next.js 项目
2. [x] 配置 Tailwind CSS 和主题系统
3. [x] 创建首页和小说列表展示
4. [x] 创建小说详情页面和章节阅读功能
5. [x] 创建记忆系统 UI(人物卡、伏笔、世界观)
6. [x] 配置 PostgreSQL + pgvector 和 LightRAG
7. [ ] **当前任务**: 实现核心创作流程

---

## 📅 里程碑记录

### Milestone 1: MVP - 2026-01-22 开始

- **状态**: 🟡 进行中
- **完成度**: 0%
- **预计完成**: 2026-02-19 (4 周后)

### Milestone 2: 完整版

- **状态**: ⚪ 未开始
- **预计开始**: 2026-02-19
- **预计完成**: 2026-03-05 (2 周后)

---

## 💡 经验教训

### 做得好的地方

- 使用第一性原理深入分析需求,明确了核心问题是"长期一致性"
- 质疑了"一次性生成 50 万字"的假设,改为分章节生成
- 设计了结构化的记忆系统(人物卡、伏笔列表、世界观设定)
- 采用 Literary Workshop 美学风格,避免了通用 AI 界面的紫色渐变
- 使用局域网访问方案,方便移动端实时测试
- 创建 CLAUDE.md 规范开发流程,使用 project-kickstart skill 跟踪进度
- 使用 Chrome DevTools MCP 进行自动化功能验证,提高测试效率
- 及时发现并修复 Next.js 15 params Promise 问题
- 正确配置 Tailwind CSS v4 暗色模式

### 需要改进的地方

暂无

### 下次可以尝试

暂无

---

## 🔗 相关链接

- PRD 文档: [docs/prd/2026-01-22-novel.md](../prd/2026-01-22-novel.md)
- GitHub 仓库: 待创建
- 测试环境: 待部署
- 生产环境: 待部署
