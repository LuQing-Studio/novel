# InkFlow v2 - å¼€å‘è¿›åº¦è·Ÿè¸ª

**PRD æ–‡æ¡£**: [docs/prd/2026-02-04-inkflow.md](../prd/2026-02-04-inkflow.md)  
**å¼€å§‹æ—¥æœŸ**: 2026-02-04  
**å½“å‰çŠ¶æ€**: ğŸŸ¢ å·²å®Œæˆ  
**æœ€åæ›´æ–°**: 2026-02-04  

---

## ğŸ“Š æ€»ä½“è¿›åº¦

- **æ•´ä½“è¿›åº¦**: 100%ï¼ˆ8/8ï¼‰
- **å½“å‰é‡Œç¨‹ç¢‘**: Milestone 8 - éªŒæ”¶é€šè¿‡

---

## âœ… é‡Œç¨‹ç¢‘ä¸ä»»åŠ¡æ¸…å•

### Milestone 1: æ–‡æ¡£ + åŒ LightRAGï¼ˆå‰§æƒ…/æŠ€æ³•ï¼‰
- [x] æ–°å»º v2 PRDï¼š`docs/prd/2026-02-04-inkflow.md`
- [x] æ–°å»º v2 è¿›åº¦ï¼š`docs/progress/2026-02-04-inkflow.md`
- [x] docker-compose å¢åŠ  `lightrag_tech`ï¼ˆ9622, novel_techï¼‰
- [x] è°ƒæ•´ç°æœ‰ `lightrag` workspace ä¸º `novel_story`ï¼ˆ9621ï¼‰
- [x] Next.js ç¯å¢ƒå˜é‡æ”¯æŒ `LIGHTRAG_TECH_BASE_URL/KEY`
- [x] `lib/lightrag/client.ts` å°è£… `getStoryRAGClient/getTechRAGClient`
- **Git æäº¤**:
  - `b65ea4e`: feat: inkflow v2 docs and schema

### Milestone 2: DB è¿ç§»ï¼ˆå·/ç« çº²/æ‰¹æ³¨/æŠ€æ³•åº“ï¼‰
- [x] `novels` æ–°å¢ `idea/overall_outline`
- [x] æ–°å¢ `volumes/chapter_plans/chapter_plan_versions`
- [x] `chapters` æ–°å¢ `volume_id/plan_id` + çº¦æŸ
- [x] æ–°å¢ `chapter_annotations`
- [x] æ–°å¢ `techniques/technique_versions` + tags GIN index
- [x] v1 æ•°æ®å›å¡«ï¼švolume(å·ä¸€) + chapter_plans + chapters.plan_id/volume_id
- **Git æäº¤**:
  - `b65ea4e`: feat: inkflow v2 docs and schema

### Milestone 3: Workbench APIï¼ˆOutliner/ç”Ÿæˆï¼‰
- [x] `GET /api/novels/[id]/workbench`
- [x] `POST/PUT volumes` + `POST volumes/generate`
- [x] `POST/PUT chapter-plans` + `POST confirm`
- [x] `POST volumes/[volumeId]/chapter-plans/generate`ï¼ˆé»˜è®¤ 10ï¼‰
- [x] `POST chapter-plans/[planId]/generate?stream=1`ï¼ˆç»‘å®šç« çº²ç”Ÿæˆæ­£æ–‡ï¼‰
- **Git æäº¤**:
  - `65c5564`: feat: inkflow v2 apis

### Milestone 4: å‰ç«¯é‡æ„ï¼ˆWorkbench ä¸»å…¥å£ï¼‰
- [x] é¦–é¡µå°è¯´å¡ç‰‡è·³è½¬åˆ° `/novels/[id]/workbench`
- [x] `/novels/[id]` é‡å®šå‘åˆ° Workbench
- [x] æ–°å¢ Workbench ä¸‰æ é¡µé¢ï¼ˆç§»åŠ¨ç«¯ Drawer/Tabï¼‰
- [x] æ–°å»ºå°è¯´å‘å¯¼ï¼ˆidea â†’ 3 æ€»çº²å€™é€‰ â†’ åˆ›å»º â†’ Workbenchï¼‰
- **Git æäº¤**:
  - `da4beba`: feat: inkflow v2 workbench ui

### Milestone 5: æŠ€æ³•åº“ï¼ˆå®Œæ•´ç®¡ç† + åŒ RAG åŒæ­¥ï¼‰
- [x] `/techniques` é¡µé¢ï¼ˆåˆ—è¡¨/æœç´¢/tag è¿‡æ»¤/ç¼–è¾‘/åˆ é™¤ï¼‰
- [x] `techniques` APIï¼ˆCRUD + versions + restoreï¼‰
- [x] åŒæ­¥ç´¢å¼•åˆ° tech LightRAGï¼ˆå¤±è´¥å¯å›é€€ï¼‰
- **Git æäº¤**:
  - `65c5564`: feat: inkflow v2 apis
  - `da4beba`: feat: inkflow v2 workbench ui

### Milestone 6: Reviewer Loopï¼ˆæ‰¹æ³¨ â†’ AI ä¿®æ”¹ â†’ è½ç‰ˆæœ¬ï¼‰
- [x] annotations APIï¼ˆGET/POST/apply/apply-and-saveï¼‰
- [x] å‰ç«¯æ‰¹æ³¨ UIï¼ˆåˆ›å»º/åˆ—è¡¨/æ‰§è¡Œ/åº”ç”¨å¹¶ä¿å­˜ï¼‰
- **Git æäº¤**:
  - `65c5564`: feat: inkflow v2 apis
  - `da4beba`: feat: inkflow v2 workbench ui

### Milestone 7: 2D å›¾è°±é»˜è®¤
- [x] çŸ¥è¯†å›¾è°±åˆ‡æ¢ä¸º 2Dï¼ˆ`react-force-graph-2d`ï¼‰
- [x] ç‚¹å‡»èŠ‚ç‚¹è¯¦æƒ…é¢æ¿æ­£å¸¸
- **Git æäº¤**:
  - `da4beba`: feat: inkflow v2 workbench ui

### Milestone 8: éªŒæ”¶éªŒè¯
- [x] `npm run lint`
- [x] `npm run build`
- [x] è¾“å‡ºå‰ç«¯é‡æ„åŠŸèƒ½æ¸…å•ï¼š`docs/plans/2026-02-04-inkflow-v2-feature-inventory.md`
- [x] å‡çº§ä¾èµ–åˆ°æœ€æ–°å¹¶æ¸…ç†å®‰å…¨æ¼æ´ï¼ˆ`npm audit` 0ï¼‰
- [x] æœ¬åœ°å¼€å‘ï¼šdocker compose æš´éœ² db/lightrag ç«¯å£ï¼ˆæ”¯æŒ `npm run dev`ï¼‰+ æ›´æ–° DeepSeek/éƒ¨ç½²æ–‡æ¡£
- [x] agent-browserï¼šæ ¸å¿ƒæµç¨‹èµ°é€šï¼ˆéœ€è¦æœ¬åœ°é…ç½® `AI_API_KEY` æ‰èƒ½å®Œæ•´éªŒè¯ï¼‰
  - å·²éªŒè¯ï¼šæ³¨å†Œ/ç™»å½• â†’ æ–°å»ºå°è¯´å‘å¯¼ï¼ˆblueprintsï¼‰â†’ Workbench â†’ AI ç”Ÿæˆå·çº² â†’ AI æ‰¹é‡ç”Ÿæˆç« çº² â†’ ç¡®è®¤ç« çº² â†’ æµå¼ç”Ÿæˆæ­£æ–‡ â†’ ç« èŠ‚é¡µ/å›¾è°±/æŠ€æ³•åº“é¡µé¢
  - å›å½’ç”¨ä¾‹ï¼šæ­£æ–‡ç”Ÿæˆé‡åˆ° `(novel_id, number)` å†²çªæ—¶è‡ªåŠ¨è½ç‰ˆæœ¬å¹¶è¦†ç›–æ—§ç« èŠ‚ï¼ˆä»…å½“æ—§ç« èŠ‚æœªç»‘å®šå…¶ä»– planï¼‰
- **Git æäº¤**:
  - `ee25cff`: fix: stabilize inkflow v2 build and migrations
  - `28be1b8`: docs: add inkflow v2 feature inventory for frontend refactor
  - `a90cc59`: fix: upgrade dependencies to latest
  - `cbbc9d5`: fix: improve local dev docker ports and docs
  - `be08b2e`: fix: harden inkflow generation and theme toggle

---

## ğŸ“ å…³é”®å†³ç­–è®°å½•

- èŒƒå›´ï¼šå…¨é¢é‡æ„ï¼ˆWorkbench ä¸ºä¸»å…¥å£ï¼‰
- å¤§çº²å±‚çº§ï¼šä¹¦-å·-ç« 
- ç« èŠ‚ç¼–å·ï¼šå…¨ä¹¦è¿ç»­
- ç« çº²é”å®šï¼šä¸¥æ ¼é”å®šï¼ˆconfirmed æ‰å…è®¸ç”Ÿæˆæ­£æ–‡ï¼›ä¿®æ”¹ä¼šè½ç‰ˆæœ¬å¹¶å›é€€ draftï¼‰
- ç« çº²ç”Ÿæˆï¼šé»˜è®¤åˆ†æ‰¹ 10 ç« 
- å·çº²ç”Ÿæˆï¼šé»˜è®¤ 5 å·ï¼›æ¯å· target ç« èŠ‚æ•°å¯è‡ªå®šä¹‰
- æŠ€æ³•åº“å½’å±ï¼šæŒ‰ç”¨æˆ·å…¨å±€
- RAG éš”ç¦»ï¼šåŒ LightRAGï¼ˆnovel_story / novel_techï¼‰
- å›¾è°±ï¼š2D é»˜è®¤

## ğŸ› ï¸ é—®é¢˜ä¸è§£å†³æ–¹æ¡ˆ

- Postgres å·²å­˜åœ¨æ•°æ®å·æ—¶ï¼Œ`docker-entrypoint-initdb.d` ä¸ä¼šå†æ¬¡æ‰§è¡Œï¼šå¯¼è‡´æœ¬åœ°ç¼ºè¡¨ï¼ˆå¦‚ `users`ï¼‰ä»è€Œæ³¨å†Œå¤±è´¥ã€‚
  - è§£å†³ï¼šæ‰‹åŠ¨æ‰§è¡Œ `db/migrations/*.sql`ï¼ˆæˆ–é‡å»º DB volumeï¼‰ã€‚
- `db/migrations/003_inkflow_v2.sql` å›å¡« `chapters.plan_id/volume_id` çš„ UPDATE åœ¨ Postgres ä¸Šå­˜åœ¨ FROM/JOIN å¼•ç”¨é™åˆ¶ã€‚
  - è§£å†³ï¼šè°ƒæ•´ UPDATE...FROM çš„ JOIN æ¡ä»¶ï¼ˆè§æäº¤ `ee25cff`ï¼‰ã€‚
- ç« çº²ç»‘å®šç”Ÿæˆæ­£æ–‡æ—¶ï¼Œè‹¥æ—§æµç¨‹å·²å­˜åœ¨åŒç« å·ç« èŠ‚ï¼Œä¼šè§¦å‘ `chapters_novel_id_number_key` å†²çªï¼ˆç”Ÿæˆå®Œæˆåè½åº“å¤±è´¥ï¼‰ã€‚
  - è§£å†³ï¼šç”Ÿæˆå‰é¢„æ£€ `(novel_id, number)` å†²çªï¼›å…è®¸è¦†ç›–æœªç»‘å®š plan çš„æ—§ç« èŠ‚ï¼Œè¦†ç›–å‰å†™å…¥ `chapter_versions` å¿«ç…§ï¼›è‹¥è¯¥ç« å·å·²ç»‘å®šå…¶ä»– plan åˆ™è¿”å› 409ã€‚
- æ‰¹é‡ç”Ÿæˆç« çº²æ—¶ï¼ŒDeepSeek å¶å‘è¾“å‡ºéä¸¥æ ¼ JSON å¯¼è‡´ `JSON.parse` å¤±è´¥ â†’ 500ã€‚
  - è§£å†³ï¼šæå– `[...]` ç‰‡æ®µå† parseï¼›å¤±è´¥æ—¶è¿”å› 502 å¹¶åœ¨ dev æä¾›æˆªæ–­ rawPreview ä¾¿äºå®šä½ã€‚
- `/login` ThemeToggle hydration mismatchï¼ˆSSR/CSR é¦–å¸§ä¸»é¢˜ä¸ä¸€è‡´å¯¼è‡´ï¼‰ã€‚
  - è§£å†³ï¼šä½¿ç”¨ `useSyncExternalStore` è®© hydration ä½¿ç”¨ä¸€è‡´å¿«ç…§ï¼Œé¿å…é¦–å¸§ DOM ä¸ä¸€è‡´ã€‚
