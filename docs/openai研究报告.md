感谢你提供完整的 OpenAI 文章。这篇文章非常详细地解释了 Codex 的 agent loop 实现。让我综合三家的内容，给你一个完整的分析。                                                                                    
                                                                                                                                                                                                               
  ---                                                                                                                                                                                                          
  综合分析：三大厂商 Agent 架构对比                                                                                                                                                                            
                                                                                                                                                                                                               
  一、Agent Loop 核心架构                                                                                                                                                                                      
                                                                                                                                                                                                               
  三家都采用相同的基础模式：ReAct 循环                                                                                                                                                                         
                                                                                                                                                                                                               
  ┌─────────────────────────────────────────────────────────┐                                                                                                                                                  
  │                    Agent Loop                           │                                                                                                                                                  
  │                                                         │                                                                                                                                                  
  │   User Input → Prompt构建 → 模型推理 → 工具调用?        │                                                                                                                                                  
  │                              ↑            │             │                                                                                                                                                  
  │                              │            ↓             │                                                                                                                                                  
  │                              ←── 观察结果 ←─            │                                                                                                                                                  
  │                                                         │                                                                                                                                                  
  │   循环直到模型返回 assistant message (无工具调用)       │                                                                                                                                                  
  └─────────────────────────────────────────────────────────┘                                                                                                                                                  
                                                                                                                                                                                                               
  ---                                                                                                                                                                                                          
  二、Prompt 构建结构（OpenAI Codex 详解）                                                                                                                                                                     
                                                                                                                                                                                                               
  OpenAI 文章揭示了 prompt 的精确构建顺序：                                                                                                                                                                    
                                                                                                                                                                                                               
  ┌─────────────────────────────────────────┐                                                                                                                                                                  
  │ 1. System Message (服务端控制)          │  ← 最高优先级                                                                                                                                                    
  ├─────────────────────────────────────────┤                                                                                                                                                                  
  │ 2. Tools 定义列表                       │                                                                                                                                                                  
  ├─────────────────────────────────────────┤                                                                                                                                                                  
  │ 3. Instructions (model_instructions)    │                                                                                                                                                                  
  ├─────────────────────────────────────────┤                                                                                                                                                                  
  │ 4. Developer Message (沙箱权限说明)     │                                                                                                                                                                  
  ├─────────────────────────────────────────┤                                                                                                                                                                  
  │ 5. Developer Instructions (用户配置)    │                                                                                                                                                                  
  ├─────────────────────────────────────────┤                                                                                                                                                                  
  │ 6. User Instructions (AGENTS.md等)      │                                                                                                                                                                  
  ├─────────────────────────────────────────┤                                                                                                                                                                  
  │ 7. Environment Context (cwd, shell)     │                                                                                                                                                                  
  ├─────────────────────────────────────────┤                                                                                                                                                                  
  │ 8. User Message                         │                                                                                                                                                                  
  └─────────────────────────────────────────┘                                                                                                                                                                  
                                                                                                                                                                                                               
  关键洞察：静态内容放前面，动态内容放后面，以最大化 prompt caching 命中率。                                                                                                                                   
                                                                                                                                                                                                               
  ---                                                                                                                                                                                                          
  三、工具设计对比                                                                                                                                                                                             
  ┌──────────┬─────────────────────┬─────────────────────────────┬──────────────────────────────┐                                                                                                              
  │   方面   │    OpenAI Codex     │          Vercel d0          │        Anthropic 建议        │                                                                                                              
  ├──────────┼─────────────────────┼─────────────────────────────┼──────────────────────────────┤                                                                                                              
  │ 核心工具 │ shell + update_plan │ ExecuteCommand + ExecuteSQL │ 最小化工具集                 │                                                                                                              
  ├──────────┼─────────────────────┼─────────────────────────────┼──────────────────────────────┤                                                                                                              
  │ 工具数量 │ 少量核心 + MCP 扩展 │ 从 12+ 精简到 2 个          │ "每个工具都是替模型做的选择" │                                                                                                              
  ├──────────┼─────────────────────┼─────────────────────────────┼──────────────────────────────┤                                                                                                              
  │ 文件编辑 │ 通过 shell 执行     │ 通过 shell 执行             │ 专用 Edit 工具               │                                                                                                              
  ├──────────┼─────────────────────┼─────────────────────────────┼──────────────────────────────┤                                                                                                              
  │ 扩展机制 │ MCP 服务器          │ 无                          │ MCP 服务器                   │                                                                                                              
  └──────────┴─────────────────────┴─────────────────────────────┴──────────────────────────────┘                                                                                                              
  OpenAI 的工具定义示例：                                                                                                                                                                                      
  {                                                                                                                                                                                                            
    "type": "function",                                                                                                                                                                                        
    "name": "shell",                                                                                                                                                                                           
    "description": "Runs a shell command and returns its output...",                                                                                                                                           
    "parameters": {                                                                                                                                                                                            
      "type": "object",                                                                                                                                                                                        
      "properties": {                                                                                                                                                                                          
        "command": {"type": "array", "description": "The command to execute"},                                                                                                                                 
        "workdir": {"description": "The working directory..."},                                                                                                                                                
        "timeout_ms": {"description": "The timeout for the command..."}                                                                                                                                        
      },                                                                                                                                                                                                       
      "required": ["command"]                                                                                                                                                                                  
    }                                                                                                                                                                                                          
  }                                                                                                                                                                                                            
                                                                                                                                                                                                               
  ---                                                                                                                                                                                                          
  四、上下文管理策略                                                                                                                                                                                           
                                                                                                                                                                                                               
  1. Prompt Caching（性能关键）                                                                                                                                                                                
                                                                                                                                                                                                               
  OpenAI 强调的缓存命中条件：                                                                                                                                                                                  
  - 精确前缀匹配：新 prompt 必须是旧 prompt 的精确前缀扩展                                                                                                                                                     
  - 避免缓存失效的操作：                                                                                                                                                                                       
    - 中途改变工具列表                                                                                                                                                                                         
    - 切换模型                                                                                                                                                                                                 
    - 修改沙箱配置                                                                                                                                                                                             
                                                                                                                                                                                                               
  最佳实践：配置变更通过追加新消息而非修改旧消息                                                                                                                                                               
                                                                                                                                                                                                               
  // 好的做法：追加新消息                                                                                                                                                                                      
  input.push({                                                                                                                                                                                                 
    type: "message",                                                                                                                                                                                           
    role: "developer",                                                                                                                                                                                         
    content: "新的权限配置..."                                                                                                                                                                                 
  })                                                                                                                                                                                                           
                                                                                                                                                                                                               
  // 坏的做法：修改旧消息（破坏缓存）                                                                                                                                                                          
  input[0].content = "修改后的内容"                                                                                                                                                                            
                                                                                                                                                                                                               
  2. Compaction（上下文压缩）                                                                                                                                                                                  
                                                                                                                                                                                                               
  当 token 接近上下文窗口限制时：                                                                                                                                                                              
                                                                                                                                                                                                               
  原始对话 (100k tokens)                                                                                                                                                                                       
          ↓                                                                                                                                                                                                    
     /responses/compact 端点                                                                                                                                                                                   
          ↓                                                                                                                                                                                                    
  压缩后的 input 列表 + encrypted_content                                                                                                                                                                      
          ↓                                                                                                                                                                                                    
  继续对话 (~10k tokens)                                                                                                                                                                                       
                                                                                                                                                                                                               
  encrypted_content 保留模型对原始对话的"潜在理解"，即使压缩后也能保持上下文连贯性。                                                                                                                           
                                                                                                                                                                                                               
  ---                                                                                                                                                                                                          
  五、安全架构                                                                                                                                                                                                 
  ┌──────────┬──────────────────────────────┬──────────────────────────────────┐                                                                                                                               
  │   层级   │         OpenAI Codex         │               说明               │                                                                                                                               
  ├──────────┼──────────────────────────────┼──────────────────────────────────┤                                                                                                                               
  │ 沙箱范围 │ 仅限 Codex 提供的 shell 工具 │ MCP 工具需自行负责安全           │                                                                                                                               
  ├──────────┼──────────────────────────────┼──────────────────────────────────┤                                                                                                                               
  │ 权限说明 │ <permissions instructions>   │ 文件权限、网络访问、审批门控     │                                                                                                                               
  ├──────────┼──────────────────────────────┼──────────────────────────────────┤                                                                                                                               
  │ ZDR 支持 │ Zero Data Retention          │ 不存储用户数据，但保留解密密钥   │                                                                                                                               
  ├──────────┼──────────────────────────────┼──────────────────────────────────┤                                                                                                                               
  │ 加密推理 │ encrypted_content            │ 推理内容加密存储，可跨 turn 解密 │                                                                                                                               
  └──────────┴──────────────────────────────┴──────────────────────────────────┘                                                                                                                               
  ---                                                                                                                                                                                                          
  六、三家核心经验总结                                                                                                                                                                                         
  ┌────────────────┬──────────────────┬──────────────────────────────────┐                                                                                                                                     
  │      经验      │       来源       │               说明               │                                                                                                                                     
  ├────────────────┼──────────────────┼──────────────────────────────────┤                                                                                                                                     
  │ Shell 优先     │ 三家共识         │ grep、cat、ls 比专用 API 更灵活  │                                                                                                                                     
  ├────────────────┼──────────────────┼──────────────────────────────────┤                                                                                                                                     
  │ 最小工具集     │ Vercel           │ 移除 80% 工具后性能提升 3.5x     │                                                                                                                                     
  ├────────────────┼──────────────────┼──────────────────────────────────┤                                                                                                                                     
  │ 信任模型       │ Vercel/Anthropic │ 停止"替模型思考"，让模型自己推理 │                                                                                                                                     
  ├────────────────┼──────────────────┼──────────────────────────────────┤                                                                                                                                     
  │ Prompt Caching │ OpenAI           │ 静态内容前置，动态内容后置       │                                                                                                                                     
  ├────────────────┼──────────────────┼──────────────────────────────────┤                                                                                                                                     
  │ Compaction     │ OpenAI/Anthropic │ 接近上下文限制时压缩对话         │                                                                                                                                     
  ├────────────────┼──────────────────┼──────────────────────────────────┤                                                                                                                                     
  │ 文档质量       │ Vercel           │ 好的 AGENTS.md 比复杂工具更重要  │                                                                                                                                     
  ├────────────────┼──────────────────┼──────────────────────────────────┤                                                                                                                                     
  │ 为未来模型构建 │ Vercel           │ 模型进步速度超过工具迭代速度     │                                                                                                                                     
  └────────────────┴──────────────────┴──────────────────────────────────┘                                                                                                                                     
  ---                                                                                                                                                                                                          
  七、推荐的 Agent 架构模板                                                                                                                                                                                    
                                                                                                                                                                                                               
  基于三家的最佳实践，推荐的架构：                                                                                                                                                                             
                                                                                                                                                                                                               
  ┌─────────────────────────────────────────────────────────┐                                                                                                                                                  
  │                    System Prompt                        │                                                                                                                                                  
  │  - 模型特定指令 (model_instructions)                    │                                                                                                                                                  
  │  - 沙箱权限说明 (permissions)                           │                                                                                                                                                  
  │  - 工具使用指南                                         │                                                                                                                                                  
  ├─────────────────────────────────────────────────────────┤                                                                                                                                                  
  │                    Tools (最小化)                       │                                                                                                                                                  
  │  - shell: 执行命令 (grep, cat, ls, find...)            │                                                                                                                                                   
  │  - edit/apply_patch: 文件编辑 (生成 diff)              │                                                                                                                                                   
  │  - 业务工具: 1-2个核心业务操作                          │                                                                                                                                                  
  ├─────────────────────────────────────────────────────────┤                                                                                                                                                  
  │                    Context Management                   │                                                                                                                                                  
  │  - AGENTS.md: 项目特定指令                              │                                                                                                                                                  
  │  - Environment: cwd, shell                              │                                                                                                                                                  
  │  - Compaction: 自动压缩长对话                           │                                                                                                                                                  
  ├─────────────────────────────────────────────────────────┤                                                                                                                                                  
  │                    Agent Loop                           │                                                                                                                                                  
  │  - ReAct: Think → Tool Call → Observe → Repeat         │                                                                                                                                                   
  │  - 单线程执行，可调试                                   │                                                                                                                                                  
  │  - 直到 assistant message 结束 turn                    │                                                                                                                                                   
  ├─────────────────────────────────────────────────────────┤                                                                                                                                                  
  │                    Safety Layer                         │                                                                                                                                                  
  │  - OS 沙箱 (Seatbelt/Docker)                           │                                                                                                                                                   
  │  - 审批门控 (suggest/auto-edit/full-auto)              │                                                                                                                                                   
  │  - 网络隔离                                             │                                                                                                                                                  
  └─────────────────────────────────────────────────────────┘                                                                                                                                                  
                                                                                                                                                                                                               
  ---                                                                                                                                                                                                          
  现在你对 agent 架构有了全面的了解。请告诉我：                                                                                                                                                                
                                                                                                                                                                                                               
  1. 你想构建什么类型的 agent？（代码助手、数据分析、研究检索、业务自动化等）                                                                                                                                  
  2. 目标用户和使用场景是什么？                                                                                                                                                                                
  3. 你倾向于使用什么技术栈？（Python、TypeScript、特定框架等）                                                                                                                                                
  4. 有什么特殊需求？（安全要求、性能要求、集成需求等）