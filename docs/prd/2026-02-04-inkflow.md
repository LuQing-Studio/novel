# InkFlow (Novel Copilot) PRD v2

**创建日期**: 2026-02-04  
**版本**: v2.0  
**状态**: Draft  
**代号**: InkFlow  

---

## 1. 项目定位

**一句话**：人为主导、AI 辅助的沉浸式长篇小说创作工坊（创作者外骨骼）。

### 1.1 从 v1 到 v2 的转向

- **v1（Novel AI）**：重点解决“长篇一致性”与“分章节生成”的工程问题（记忆系统 + 生成 + 审核 + 导出）。
- **v2（InkFlow）**：重点解决“创作者表达能力不足”与“长篇结构熵增”的创作问题（分形大纲 + 工坊式写作流 + 技法库 + 批注审阅闭环）。

### 1.2 核心价值

1. **主导权回归**：人负责结构与审美（大纲/伏笔/节奏/审阅），AI 负责肌肉（扩写/润色/查漏补缺）。
2. **分层创作漏斗**：灵感 → 总纲 → 卷纲 → 章纲（确认）→ 正文 → 读者视角审阅（批注）→ AI 定点修订。
3. **技法知识库（RAG 新用法）**：让 AI 检索并执行“写作技巧”，而不是只模仿剧情。
4. **可视化管理**：2D 图谱/全局视图辅助长期一致性与伏笔回收。

---

## 2. 目标用户与约束

### 2.1 目标用户

- 有大量网文阅读经验
- 脑海画面感强，但表达/渲染能力不足
- 希望写长篇（50 万～100 万字），且不想被 AI “带着跑”

### 2.2 不可约束（Fundamentals）

- LLM 上下文窗口有限：必须做上下文预算与相关性注入
- 长篇结构熵增：必须以结构化系统（大纲/章纲/伏笔/人物状态）对抗遗忘
- 审美不可替代：必须让人处在“第一读者/最终审阅者”的位置

---

## 3. 功能模块（v2）

### 3.1 分形大纲系统（Fractal Outliner）

层级：**书 → 卷 → 章纲（章计划）**  
流程约束（严格）：
- 章纲未确认（confirmed）→ **禁止生成正文**
- 正文生成后修改章纲 → 必须走“章纲版本/修订”，并回退为 draft 重新确认

能力：
- 书级：灵感（idea）、总纲（overall outline）
- 卷级：卷纲（outline）、目标章数（target chapters，可自定）
- 章级：章节号（全书连续 1..N）、章标题、章梗概（100-200 字）、状态（draft/confirmed/drafted/done）

### 3.2 Workbench（三栏工坊）

桌面端三栏：
1) 左：大纲树（卷/章）  
2) 中：编辑器（章纲/正文 Tab）  
3) 右：助手（写作/记忆/伏笔/批注 Tab）

移动端：
- 左侧大纲 → Drawer
- 右侧助手 → Tab
- 中间编辑器占满

### 3.3 动态知识库（The Knowledge Engine）

两类知识库：
1) **剧情记忆库（自动维护）**：人物/世界观/伏笔/章节（延续 v1）
2) **技法知识库（人工导入）**：写作技巧文章/教程/书摘，按标签组织，检索用于“改写/扩写/氛围渲染”

隔离策略（强隔离）：
- **双 LightRAG**：剧情与技法使用不同 workspace/端口，避免互相污染

### 3.4 读者视角审阅流（Reviewer Loop）

能力：
- 在正文中对片段创建批注（类似 Word 批注）
- AI 读取（原文片段 + 批注 + 技法库）进行定点重写
- 一键应用并自动落版本（chapter_versions）

### 3.5 知识图谱可视化（2D 默认）

- 使用 `react-force-graph-2d` 呈现人物/世界观/伏笔的力导向图
- 目标：轻量、可读、移动端可用（相比 3D 更稳）

---

## 4. 数据模型（高层）

新增核心实体：
- `volumes`：卷
- `chapter_plans`：章纲/章计划（生成正文的前置条件）
- `chapter_plan_versions`：章纲版本（严格锁定改动）
- `chapter_annotations`：批注（Reviewer Loop）
- `techniques`：技法库（按用户全局）
- `technique_versions`：技法库版本历史

章节正文与章纲绑定：
- `chapters.plan_id` → `chapter_plans.id`
- `chapters.volume_id` → `volumes.id`

---

## 5. API（高层）

### 5.1 Workbench/Outliner
- `GET /api/novels/[id]/workbench`
- `POST /api/novels/[id]/volumes`
- `PUT /api/novels/[id]/volumes/[volumeId]`
- `POST /api/novels/[id]/volumes/generate`（AI）
- `POST /api/novels/[id]/chapter-plans`
- `PUT /api/novels/[id]/chapter-plans/[planId]`（严格锁定：confirmed/drafted/done 会先落版本再回退 draft）
- `POST /api/novels/[id]/chapter-plans/[planId]/confirm`
- `POST /api/novels/[id]/volumes/[volumeId]/chapter-plans/generate`（AI 批量 10 章默认）

### 5.2 章纲绑定正文生成（流式）
- `POST /api/novels/[id]/chapter-plans/[planId]/generate?stream=1`

### 5.3 批注审阅
- `GET /api/novels/[id]/chapters/[chapterId]/annotations`
- `POST /api/novels/[id]/chapters/[chapterId]/annotations`
- `POST /api/novels/[id]/chapters/[chapterId]/annotations/[annotationId]/apply`
- `POST /api/novels/[id]/chapters/[chapterId]/annotations/[annotationId]/apply-and-save`

### 5.4 技法库（全局按用户）
- `GET /api/techniques?query=&tag=`
- `POST /api/techniques`
- `GET /api/techniques/[id]`
- `PUT /api/techniques/[id]`
- `DELETE /api/techniques/[id]`
- `GET /api/techniques/[id]/versions`
- `POST /api/techniques/[id]/versions/restore`

### 5.5 新建小说（InkFlow 流程）
- `POST /api/novels/blueprints`（AI 生成 3 个总纲候选）

---

## 6. 验收标准（VDD）

### 6.1 关键用户旅程（必须通过）
1. 登录后新建小说：输入 idea + genre → 生成 3 个总纲候选 → 选择并创建成功
2. 进入 Workbench：看到卷/章结构，能编辑并保存卷纲
3. 生成章纲：对某卷批量生成 10 章梗概；可手动修改
4. 章纲确认：未确认时禁止生成正文；确认后允许生成正文（流式）
5. 正文编辑：支持原地编辑与“选中文本 AI 改写”，并能保存版本
6. 批注审阅：创建批注 → AI 生成替换建议 → 应用并保存 → 自动写入版本且批注状态变更
7. 技法库：创建/编辑/删除/版本恢复；同步索引到技法 LightRAG；写作改写可注入技法
8. 图谱：知识图谱 2D 正常加载、可拖拽、点击节点查看详情

### 6.2 性能与稳定性
- Workbench 首屏 < 3s（本地开发可接受更宽）
- 生成接口支持流式，用户可见进度
- 移动端布局不溢出、不遮挡关键按钮

---

## 7. 风险与应对

1. **章纲与正文不同步**：严格锁定 + 版本机制 + 明确状态提示
2. **技法库污染剧情**：双 LightRAG workspace 强隔离
3. **AI 输出不稳定**：JSON 解析健壮性（去代码块）+ 最小可用回退（手动编辑）

---

## 8. 变更记录

| 日期 | 版本 | 变更内容 |
|------|------|----------|
| 2026-02-04 | v2.0 | InkFlow v2 PRD 创建：分形大纲 + Workbench + 技法库 + Reviewer Loop + 2D 图谱 |

