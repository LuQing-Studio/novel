---                                                                                                                                                                                                          
  Agent 开发方案研究报告                                                                                                                                                                                       
                                                                                                                                                                                                               
  基于 Vercel、Anthropic 和 OpenAI 的最新实践，以下是核心发现：                                                                                                                                                
                                                                                                                                                                                                               
  ---                                                                                                                                                                                                          
  一、核心设计原则（三家共识）                                                                                                                                                                                 
  ┌───────────────────────┬─────────────────────────────────────────────────────────────────────────────┐                                                                                                      
  │         原则          │                                    说明                                     │                                                                                                      
  ├───────────────────────┼─────────────────────────────────────────────────────────────────────────────┤                                                                                                      
  │ 简单优先              │ Vercel 移除 80% 工具后性能提升 3.5 倍；Anthropic 强调"只在必要时增加复杂度" │                                                                                                      
  ├───────────────────────┼─────────────────────────────────────────────────────────────────────────────┤                                                                                                      
  │ 信任模型              │ 停止"替模型思考"，让模型自己推理和决策                                      │                                                                                                      
  ├───────────────────────┼─────────────────────────────────────────────────────────────────────────────┤                                                                                                      
  │ Shell/文件系统优先    │ 用 grep、cat、ls、find 等 Unix 工具，而非大量专用 API                       │                                                                                                      
  ├───────────────────────┼─────────────────────────────────────────────────────────────────────────────┤                                                                                                      
  │ 上下文质量 > 工具数量 │ 好的文档和数据结构比复杂工具更重要                                          │                                                                                                      
  └───────────────────────┴─────────────────────────────────────────────────────────────────────────────┘                                                                                                      
  ---                                                                                                                                                                                                          
  二、推荐架构模式                                                                                                                                                                                             
                                                                                                                                                                                                               
  1. 核心循环：ReAct 模式                                                                                                                                                                                      
                                                                                                                                                                                                               
  Think → Tool Call → Observe → Repeat                                                                                                                                                                         
                                                                                                                                                                                                               
  OpenAI Codex 和 Claude Code 都采用这种单线程、可调试的执行流程。                                                                                                                                             
                                                                                                                                                                                                               
  2. 最小工具集（推荐）                                                                                                                                                                                        
  ┌────────────────────────┬──────────────────────────────────────────┐                                                                                                                                        
  │          工具          │                   用途                   │                                                                                                                                        
  ├────────────────────────┼──────────────────────────────────────────┤                                                                                                                                        
  │ ExecuteCommand / Shell │ 执行 bash 命令（grep、cat、ls、find 等） │                                                                                                                                        
  ├────────────────────────┼──────────────────────────────────────────┤                                                                                                                                        
  │ ApplyPatch / Edit      │ 文件编辑（生成 diff 而非全文重写）       │                                                                                                                                        
  ├────────────────────────┼──────────────────────────────────────────┤                                                                                                                                        
  │ ExecuteSQL / 业务工具  │ 执行最终业务操作                         │                                                                                                                                        
  └────────────────────────┴──────────────────────────────────────────┘                                                                                                                                        
  Vercel 的经验：从 12+ 工具精简到 2 个，成功率从 80% 提升到 100%。                                                                                                                                            
                                                                                                                                                                                                               
  3. 架构层次                                                                                                                                                                                                  
                                                                                                                                                                                                               
  ┌─────────────────────────────────────┐                                                                                                                                                                      
  │           System Prompt             │  ← 编码安全策略、操作模式、工具文档                                                                                                                                  
  ├─────────────────────────────────────┤                                                                                                                                                                      
  │         Agent Loop (ReAct)          │  ← Think → Act → Observe                                                                                                                                             
  ├─────────────────────────────────────┤                                                                                                                                                                      
  │      Minimal Tool Set (2-3个)       │  ← Shell + Edit + 业务工具                                                                                                                                           
  ├─────────────────────────────────────┤                                                                                                                                                                      
  │     Sandbox / 安全隔离层            │  ← macOS Seatbelt / Docker                                                                                                                                           
  └─────────────────────────────────────┘                                                                                                                                                                      
                                                                                                                                                                                                               
  ---                                                                                                                                                                                                          
  三、上下文工程策略                                                                                                                                                                                           
                                                                                                                                                                                                               
  这是 Anthropic 强调的关键技术：                                                                                                                                                                              
                                                                                                                                                                                                               
  1. 即时检索（Just-in-time）                                                                                                                                                                                  
                                                                                                                                                                                                               
  - 维护轻量级标识符（文件路径、链接）                                                                                                                                                                         
  - 运行时动态加载，避免预加载大量数据                                                                                                                                                                         
                                                                                                                                                                                                               
  2. 压缩（Compaction）                                                                                                                                                                                        
                                                                                                                                                                                                               
  - 接近上下文窗口限制时，总结对话                                                                                                                                                                             
  - 保留：架构决策、未解决 bug、关键实现                                                                                                                                                                       
  - 丢弃：冗余工具输出、深层历史                                                                                                                                                                               
                                                                                                                                                                                                               
  3. 子 Agent 架构                                                                                                                                                                                             
                                                                                                                                                                                                               
  - 子 agent 处理聚焦任务，消耗数万 token                                                                                                                                                                      
  - 只返回 1000-2000 token 的摘要给主 agent                                                                                                                                                                    
                                                                                                                                                                                                               
  ---                                                                                                                                                                                                          
  四、工具设计最佳实践                                                                                                                                                                                         
                                                                                                                                                                                                               
  ## 好的工具设计                                                                                                                                                                                              
  - 返回 token 高效的信息                                                                                                                                                                                      
  - 功能明确，避免重叠                                                                                                                                                                                         
  - 自包含、错误健壮                                                                                                                                                                                           
  - 参数描述清晰无歧义                                                                                                                                                                                         
  - "像给初级开发者写文档一样写工具描述"                                                                                                                                                                       
                                                                                                                                                                                                               
  ## Diff 优先                                                                                                                                                                                                 
  - 生成最小、可审查的修改                                                                                                                                                                                     
  - 便于 review 和 rollback                                                                                                                                                                                    
  - 自然的迭代循环：生成 diff → review → apply → test                                                                                                                                                          
                                                                                                                                                                                                               
  ---                                                                                                                                                                                                          
  五、安全架构                                                                                                                                                                                                 
  ┌──────────┬───────────────────────────────────────────┐                                                                                                                                                     
  │   层级   │                   实现                    │                                                                                                                                                     
  ├──────────┼───────────────────────────────────────────┤                                                                                                                                                     
  │ 操作模式 │ Suggest（只读）→ Auto-Edit → Full Auto    │                                                                                                                                                     
  ├──────────┼───────────────────────────────────────────┤                                                                                                                                                     
  │ 审批门控 │ 每个操作分类，决定是否需要用户确认        │                                                                                                                                                     
  ├──────────┼───────────────────────────────────────────┤                                                                                                                                                     
  │ OS 沙箱  │ macOS: Seatbelt；Linux: Docker + iptables │                                                                                                                                                     
  ├──────────┼───────────────────────────────────────────┤                                                                                                                                                     
  │ 网络隔离 │ 默认禁止网络访问                          │                                                                                                                                                     
  └──────────┴───────────────────────────────────────────┘                                                                                                                                                     
  ---                                                                                                                                                                                                          
  六、关键经验教训                                                                                                                                                                                             
                                                                                                                                                                                                               
  1. "Addition by Subtraction" - 最好的 agent 可能是工具最少的                                                                                                                                                 
  2. 为未来的模型构建 - 模型进步速度超过工具迭代速度                                                                                                                                                           
  3. 文档质量决定成败 - 原始文件访问只在数据层结构良好时有效                                                                                                                                                   
  4. Lazy Loading 的权衡 - 节省 token 但可能导致幻觉                                                                                                                                                           
                                                                                                                                                                                                               
  ---                                                                                                                                                                                                          
  下一步建议                                                                                                                                                                                                   
                                                                                                                                                                                                               
  你想构建什么类型的 agent？我可以根据具体场景帮你设计：                                                                                                                                                       
                                                                                                                                                                                                               
  1. 代码助手 Agent - 类似 Claude Code / Codex                                                                                                                                                                 
  2. 数据分析 Agent - 类似 Vercel d0                                                                                                                                                                           
  3. 研究/检索 Agent - 多 agent 协作                                                                                                                                                                           
  4. 自定义业务 Agent - 特定领域                                                                                                                                                                               
                                    